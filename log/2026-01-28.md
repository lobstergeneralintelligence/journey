# 2026-01-28 - LGI-MM Balance Parser Fix

## Session Context
Continuing lgi-mm market maker testing after crash. Testing with CLAWDIA token on Base.

## Problem
Balance parser in `src/bankr/client.ts` couldn't parse Bankr's response format.

**Bankr returns:**
```
ETH - 0.002732388974206735 ($8.30)
Token (0xbbd9aDe16525acb4B336b6dAd3b9762901522B07) - 1260425.075644998881241559 on Base
```

**Old parser expected:** `TOKEN: BALANCE` or `BALANCE TOKEN` formats

## Investigation
1. Ran market maker in dry-run mode
2. Noticed warnings: "Could not parse balance from Bankr response"
3. Checked the Bankr response format by running direct balance queries
4. Identified the pattern: `TOKEN - BALANCE` with optional extras

## Solution
Updated `parseBalance()` function to handle the `- NUMBER` pattern first:

```typescript
// Bankr format: "TOKEN - NUMBER" or "Token (0x...) - NUMBER"
/[-â€“]\s*([0-9,]+\.?[0-9]*)/,
```

## Testing
1. Rebuilt with `npm run build`
2. Ran market maker with $5 position size, live mode
3. **Results:**
   - Price fetched correctly: $7.67e-7
   - Balances parsed: ETH (0.00273), CLAWDIA (1,260,425) âœ…
   - Rebalance logic triggered: sell signal âœ…
   - Trade submitted using CA (not ticker) âœ…
   - Trade execution timed out (Bankr API is slow ~30s per call)

## Commits
- `2d61094` - ðŸ¦ž Fix balance parser for Bankr response format

## Key Learnings
- Always use contract address (CA) when interacting with Bankr, not ticker symbols
- Bankr API calls take ~30 seconds each â€” need to account for this in timeouts
- Test with small amounts ($5) first
- Telegram broadcasts use HTML format, not Markdown

## Config Used
```json
{
  "pair": {
    "base": "CLAWDIA",
    "baseAddress": "0xbbd9aDe16525acb4B336b6dAd3b9762901522B07",
    "quote": "ETH",
    "chain": "base"
  },
  "strategy": {
    "spreadPercent": 5.0,
    "positionSize": 5,
    "rebalanceThreshold": 15
  },
  "dryRun": false
}
```

## Second Test - Extended Timeout (3 min)

### Result: SUCCESS! ðŸŽ‰

**Trade executed:**
- Swapped 0.00032 ETH â†’ 1,260,424 CLAWDIA
- TX: https://basescan.org/tx/0xbfe6c70f2319e1cd001c65645ac24c7f4c5b39abc510df86e8c0b002c2e7d97e

**New parser bug found:**
Bankr returned: `"you currently have 0 of the token 0xbbd9..."`
Parser didn't handle conversational format â†’ thought balance was 0 â†’ triggered buy

**Fix applied:**
Added patterns for `"you currently have X"` and `"you hold X"` formats

**Commits:**
- `81f224e` - ðŸ¦ž Fix parser for 'you currently have X' format

### Post-Trade Balances
- ETH: 0.00272 (~$8.27)
- CLAWDIA: 1,260,424 tokens

## Accumulate Mode Implementation

### Design
Two operating modes designed:
1. **Liquidity** - For token project owners (support price, rebalance)
2. **Accumulate** - For DCA/stacking (time-based buys + dip buying)

### Implementation (accumulate mode)
Created `src/core/accumulate.ts` with:
- Time-based DCA buys (configurable interval)
- Dip detection from recent high
- Optional take-profit on pumps
- Max accumulation limit

### Key Decisions
1. **Use DexScreener for price** - Fast, avoids Bankr API flagging tokens
2. **Only fetch quote (ETH) balance from Bankr** - Minimizes API calls
3. **Track token balance in state** - Avoids querying flagged token
4. **Hardcoded ETH price ($3000)** - TODO: fetch real price

### Bug Fixes During Implementation
- Fixed balance check: was comparing ETH amount to USD, now converts properly
- Fixed Bankr response parsing for "you currently have X" format

### Test Results
```
Price fetch: instant (DexScreener)
Balance: 0.00272 ETH (~$8.17 USD)
[DRY RUN] Would BUY $2 of CLAWDIA (DCA) âœ…
```

### Commits
- `45a05b2` - ðŸ¦ž Add MODES.md - design doc
- `f9b0d77` - ðŸ¦ž Implement accumulate mode

## Manual Buy/Sell Test

Testing Bankr trading flow directly before relying on it in automated mode.

### BUY Test
```
Prompt: "Buy $1 worth of 0xbbd9aDe16525acb4B336b6dAd3b9762901522B07 on Base"
Result: Swapped 0.000324 ETH â†’ 1,277,765 CLAWDIA
TX: https://basescan.org/tx/0x7088c8a9496fe9c85b50db92583ec62cf83e71799dd5d4cef1351e70a1fcec42
```

### SELL Test
```
Prompt: "Sell all of my 0xbbd9aDe16525acb4B336b6dAd3b9762901522B07 tokens on Base"
Result: Swapped 2,538,190 CLAWDIA â†’ 0.000624 ETH
TX: https://basescan.org/tx/0xc205a1472d4992490ad22b27aec1924fe937240ec749b71d1de4eb0e327ae7e5
```

**Note:** Sold more than bought because had existing balance from earlier tests.

### Conclusion
âœ… Buy works
âœ… Sell works
âœ… Bankr handles CA correctly
âœ… Ready for automated mode testing

## Next Steps
- Run live accumulate mode test
- Implement liquidity mode
- Add state persistence (survive restarts)
- Get real ETH price instead of hardcoded
