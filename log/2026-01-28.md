# 2026-01-28 - LGI-MM Balance Parser Fix

## Session Context
Continuing lgi-mm market maker testing after crash. Testing with CLAWDIA token on Base.

## Problem
Balance parser in `src/bankr/client.ts` couldn't parse Bankr's response format.

**Bankr returns:**
```
ETH - 0.002732388974206735 ($8.30)
Token (0xbbd9aDe16525acb4B336b6dAd3b9762901522B07) - 1260425.075644998881241559 on Base
```

**Old parser expected:** `TOKEN: BALANCE` or `BALANCE TOKEN` formats

## Investigation
1. Ran market maker in dry-run mode
2. Noticed warnings: "Could not parse balance from Bankr response"
3. Checked the Bankr response format by running direct balance queries
4. Identified the pattern: `TOKEN - BALANCE` with optional extras

## Solution
Updated `parseBalance()` function to handle the `- NUMBER` pattern first:

```typescript
// Bankr format: "TOKEN - NUMBER" or "Token (0x...) - NUMBER"
/[-â€“]\s*([0-9,]+\.?[0-9]*)/,
```

## Testing
1. Rebuilt with `npm run build`
2. Ran market maker with $5 position size, live mode
3. **Results:**
   - Price fetched correctly: $7.67e-7
   - Balances parsed: ETH (0.00273), CLAWDIA (1,260,425) âœ…
   - Rebalance logic triggered: sell signal âœ…
   - Trade submitted using CA (not ticker) âœ…
   - Trade execution timed out (Bankr API is slow ~30s per call)

## Commits
- `2d61094` - ðŸ¦ž Fix balance parser for Bankr response format

## Key Learnings
- Always use contract address (CA) when interacting with Bankr, not ticker symbols
- Bankr API calls take ~30 seconds each â€” need to account for this in timeouts
- Test with small amounts ($5) first
- Telegram broadcasts use HTML format, not Markdown

## Config Used
```json
{
  "pair": {
    "base": "CLAWDIA",
    "baseAddress": "0xbbd9aDe16525acb4B336b6dAd3b9762901522B07",
    "quote": "ETH",
    "chain": "base"
  },
  "strategy": {
    "spreadPercent": 5.0,
    "positionSize": 5,
    "rebalanceThreshold": 15
  },
  "dryRun": false
}
```

## Next Steps
- Run longer test to see trade complete
- Consider caching balances to reduce API calls
- Add position size validation against actual balance
